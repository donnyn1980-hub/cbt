<div id="success-screen" class="page">
    <div class="card" style="text-align: center;">
        <i class="fas fa-check-circle" style="font-size: 64px; color: var(--success); margin-bottom: 20px;"></i>
        <h2 id="success-title">Jawaban Berhasil Terkirim</h2>
        <p id="success-message" style="line-height: 1.6; color: var(--secondary); margin-bottom: 25px;"></p>
        <div style="background: #e8f0fe; padding: 15px; border-radius: 8px; font-weight: 500; color: #1967d2;">
            Tunjukkan teks ini kepada Pengawas untuk meninggalkan Ruangan.
        </div>
    </div>
</div>

<script>
    // ... (kode lainnya tetap sama) ...

    async function submitUjian() {
        if (!confirm('Yakin ingin mengakhiri ujian?')) return;
        id('loading-screen').style.display = 'flex';

        // LOGIKA BARU: Mengurutkan jawaban berdasarkan rowid agar tertata di kolom database
        // questions adalah array soal yang kita miliki
        const sortedQuestions = [...questions].sort((a, b) => a.id - b.id);
        
        const logAns = sortedQuestions.map(q => {
            const j = ans[q.id];
            if (!j) return "-";
            return Array.isArray(j) ? j.sort().join(',') : j;
        }).join('|');

        let totalPoinBenar = 0;
        let totalPoinMaksimal = 0;
        let tBF = 0; 
        let tS = 0;

        questions.forEach(q => {
            const bobot = parseFloat(q.bobot) || 0;
            totalPoinMaksimal += bobot;
            if (cekJawaban(ans[q.id], q.key)) {
                totalPoinBenar += bobot;
                tBF++;
            } else {
                tS++;
            }
        });

        const finalNilai = totalPoinMaksimal > 0 ? ((totalPoinBenar / totalPoinMaksimal) * 100).toFixed(2) : 0;
        const tOut = new Date();
        const durasiMenit = Math.floor((tOut - new Date(tIn)) / 60000);

        const body = {
            nisn: String(u.nisn), 
            nama: u.nama, 
            nama_guru: ex.nama_guru, 
            mapel: ex.mapel, 
            kelas: u.kelas, 
            jenjang: u.jenjang,
            nilai: finalNilai, 
            jml_curang: fraud, 
            jml_benar: tBF, 
            jml_salah: tS,
            wkt_masuk: new Date(tIn).toLocaleString('id-ID'), 
            wkt_submit: tOut.toLocaleString('id-ID'),
            wkt_digunakan: `${durasiMenit} Menit`, 
            jawaban: logAns
        };

        try {
            // URL disesuaikan dengan worker Anda
            const res = await fetch('https://cbt.donnyn1980.workers.dev/submit', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body)
            });
            
            if (res.ok) {
                // Update tampilan layar sukses sesuai permintaan
                id('success-message').innerHTML = `Selamat <b>${u.nama} (${u.kelas})</b>, Anda telah menyelesaikan ujian <b>${ex.mapel}</b> dengan durasi <b>${durasiMenit} menit</b>. Semoga mendapatkan hasil yang terbaik.`;
                
                localStorage.removeItem('cbt_session');
                id('loading-screen').style.display = 'none'; 
                id('exam-screen').classList.remove('active');
                id('success-screen').classList.add('active');
            } else {
                alert('Gagal mengirim jawaban. Coba lagi atau lapor pengawas.');
            }
        } catch (e) {
            alert('Gangguan koneksi. Jawaban belum terkirim.');
        } finally {
            id('loading-screen').style.display = 'none';
        }
    }
</script>
